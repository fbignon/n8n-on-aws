Write-Host " Removendo Elastic IP do Terraform state..."
./run-terraform.ps1 state rm aws_eip.n8n_eip


# Verifica se AWS CLI está disponível
if (-not (Get-Command aws -ErrorAction SilentlyContinue)) {
  Write-Host " AWS CLI não encontrada. Verifique se está instalada e no PATH."
  exit 1
}

Write-Host " Buscando Allocation ID do EIP atual..."
$allocationId = aws ec2 describe-addresses `
  --query 'Addresses[?Tags[?Key==''Name'' && Value==''n8n-instance-eip'']].AllocationId' `
  --output text


if ([string]::IsNullOrWhiteSpace($allocationId)) {
    Write-Host " AllocationId não encontrado. O EIP pode já ter sido liberado ou renomeado."
    exit 1
}

Write-Host " Liberando Elastic IP: $allocationId"
aws ec2 release-address --allocation-id $allocationId

Write-Host '[OK] Elastic IP liberado com sucesso.'
