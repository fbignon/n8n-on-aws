#!/bin/bash

# Requer: terraform instalado e 'terraform output' acess√≠vel
#         awscli configurado com credenciais v√°lidas

Write-Host "üîÑ Removendo Elastic IP do Terraform state..."
terraform state rm aws_eip.n8n_eip

# Verifica se AWS CLI est√° dispon√≠vel
if (-not (Get-Command aws -ErrorAction SilentlyContinue)) {
  Write-Host "‚ùå AWS CLI n√£o encontrada. Verifique se est√° instalada e no PATH."
  exit 1
}

Write-Host "üîç Buscando Allocation ID do EIP atual..."
$allocationId = aws ec2 describe-addresses `
  --query 'Addresses[?Tags[?Key==`'Name`' -and Value==`'n8n-instance-eip`']].AllocationId' `
  --output text

if ([string]::IsNullOrWhiteSpace($allocationId)) {
    Write-Host "‚ùå AllocationId n√£o encontrado. O EIP pode j√° ter sido liberado ou renomeado."
    exit 1
}

Write-Host "üß® Liberando Elastic IP: $allocationId"
aws ec2 release-address --allocation-id $allocationId

Write-Host ""
Write-Host "[OK] Elastic IP liberado com sucesso."
Write-Host ""
